#!/bin/bash
set -eux

if [ $# -eq 0 ] ; then
    echo "ERROR: You must provide the platform as a command-line argument"
    exit 1
fi

SITE=${1}

FV3GFS_DIR=$( pwd )/..
if [ ${SITE} == "cheyenne" ]; then
  export NCEPLIB_DIR=/glade/p/ral/jntp/GMTB/tools/NCEPlibs/20180717/intel-18.0.1/
fi

cd ${FV3GFS_DIR}/sorc
./build_fre-nctools.sh ${SITE} >& out.build_fre-nctools
./build_orog.sh ${SITE}        >& out.build_orog
./build_chgres.sh ${SITE}      >& out.build_chgres

#cd ${FV3GFS_DIR}/../NEMSfv3gfs/tests
#./compile.sh ${FV3GFS_DIR}/../NEMSfv3gfs/FV3 ${SITE} "DEBUG=Y 32BIT=Y" 32bit YES NO >& make.out.32bit

# prepare fixed data directories

cd ${FV3GFS_DIR}
mkdir -p fix/fix_fv3
cd fix

if [ ${SITE} == "theia" ]; then

    ln -sfn /scratch4/NCEPDEV/global/save/glopara/git/fv3gfs/fix/fix_am fix_am

elif [ ${SITE} == "wcoss_cray" ]; then

    ln -sfn /gpfs/hps3/emc/global/noscrub/emc.glopara/git/fv3gfs/fix/fix_am  fix_am
    echo "module swap pmi pmi/5.0.11" >> ${FV3GFS_DIR}/../NEMSfv3gfs/modulefiles/wcoss_cray/fv3

elif [ ${SITE} == "odin" ]; then

    ln -sfn /scratch/ywang/test_runs/C768_nest/fv3-fix fix_am

elif [ ${SITE} == "cheyenne" ]; then

    ln -sfn /glade/p/ral/jntp/GMTB/FV3GFS_V1_RELEASE/fix/fix_am/ fix_am

elif [ ${SITE} == "jet" ]; then

    ln -sfn regional/build_regional/fix/fix_am fix_am
else
    echo "Unknown site " ${SITE}
    exit
fi
