#!/bin/bash
set -eux

if [ $# -eq 0 ] ; then
    echo "ERROR: You must provide the platform as a command-line argument"
    exit 1
fi

SITE=${1}

RGNL_WFLOW_DIR=$( pwd )/..
if [ ${SITE} == "cheyenne" ]; then
  export NCEPLIB_DIR=/glade/p/ral/jntp/GMTB/tools/NCEPlibs/20180717/intel-18.0.1/
fi

cd ${RGNL_WFLOW_DIR}/sorc
#
# The following build several new utilities needed in order to use the
# new Jim Purser-type grid in the SAR.  The following only works on
# theia for now.  It needs to be ported to other platforms.
#
./build_regional_grid.sh ${SITE}         >& out.build_regional_grid
./build_global_equiv_resol.sh ${SITE}    >& out.build_global_equiv_resol
./build_mosaic_file.sh ${SITE}           >& out.build_mosaic_file
#
# Build sfc_climo_gen.
#
cd ${RGNL_WFLOW_DIR}/sorc/UFS_UTILS_develop/sorc
./build_sfc_climo_gen.sh >& out.build_sfc_climo_gen
cp ../exec/sfc_climo_gen ${RGNL_WFLOW_DIR}/exec
#
# Build fre-nctools.
#
./build_fre-nctools.sh >& out.build_fre-nctools
cp ../exec/filter_topo ${RGNL_WFLOW_DIR}/exec
cp ../exec/fregrid ${RGNL_WFLOW_DIR}/exec
cp ../exec/fregrid_parallel ${RGNL_WFLOW_DIR}/exec
cp ../exec/make_hgrid ${RGNL_WFLOW_DIR}/exec
cp ../exec/make_hgrid_parallel ${RGNL_WFLOW_DIR}/exec
cp ../exec/make_solo_mosaic ${RGNL_WFLOW_DIR}/exec
cp ../exec/shave.x ${RGNL_WFLOW_DIR}/exec
#
# Build orog.
#
./build_orog.sh >& out.build_orog
cp ../exec/orog.x ${RGNL_WFLOW_DIR}/exec
#
# Build chgres_cube.
#
# The first case is using Larissa's make.sh script, the second case uses
# the more formal way also used by the other codes in UFS_UTILS.
if [ 0 = 1 ]; then
  cd ${RGNL_WFLOW_DIR}/sorc/UFS_UTILS_chgres_grib2/sorc/chgres_cube.fd
  ./make.sh >& out.build_chgres_cube
# Is the following needed?  The version of the global_chgres.exe execu-
# table used by the tasks that use chgres_cube (the ICs/surf/LBC0 and
# LBC1_to_LBCN tasks) is located in the exec directory under the UFS_-
# UTILS_chgres_grib2 directory, not in ${RGNL_WFLOW_DIR}/exec.
  cp ../exec/global_chgres.exe ${RGNL_WFLOW_DIR}/exec
else
  cd ${RGNL_WFLOW_DIR}/sorc/UFS_UTILS_chgres_grib2_gsd/sorc
  ./build_chgres_cube.sh >& out.build_chgres_cube
# Is the following needed?  The version of the global_chgres.exe execu-
# table used by the tasks that use chgres_cube (the ICs/surf/LBC0 and
# LBC1_to_LBCN tasks) is located in the exec directory under the UFS_-
# UTILS_chgres_grib2 directory, not in ${RGNL_WFLOW_DIR}/exec.
  cp ../exec/chgres_cube.exe ${RGNL_WFLOW_DIR}/exec
fi

#
# Built EMC_post
#
cd ${RGNL_WFLOW_DIR}/sorc/EMC_post/sorc
./build_ncep_post.sh >& out.build_EMC_post
cp ../exec/ncep_post ${RGNL_WFLOW_DIR}/exec

# prepare fixed data directories

cd ${RGNL_WFLOW_DIR}
mkdir -p fix/fix_fv3
cd fix

if [ ${SITE} == "theia" ]; then

    ln -sfn /scratch4/NCEPDEV/global/save/glopara/git/fv3gfs/fix/fix_am fix_am

elif [ ${SITE} == "hera" ]; then

    ln -sfn /scratch1/NCEPDEV/global/glopara/fix/fix_am fix_am

elif [ ${SITE} == "wcoss" ] || [ ${SITE} == "dell" ]; then

    ln -sfn /gpfs/dell2/emc/modeling/noscrub/emc.glopara/git/fv3gfs/fix/fix_am fix_am

elif [ ${SITE} == "wcoss_cray" ]; then

    ln -sfn /gpfs/hps3/emc/global/noscrub/emc.glopara/git/fv3gfs/fix/fix_am  fix_am
    echo "module swap pmi pmi/5.0.11" >> ${FV3GFS_DIR}/../NEMSfv3gfs/modulefiles/wcoss_cray/fv3

elif [ ${SITE} == "odin" ]; then

    ln -sfn /scratch/ywang/fix/theia_fix/fix_am fix_am

elif [ ${SITE} == "cheyenne" ]; then

    ln -sfn /glade/p/ral/jntp/GMTB/FV3GFS_V1_RELEASE/fix/fix_am/ fix_am

elif [ ${SITE} == "jet" ]; then

    ln -sfn regional/build_regional/fix/fix_am fix_am

else

    echo "Unknown site " ${SITE}
    exit

fi
