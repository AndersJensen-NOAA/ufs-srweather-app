<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE workflow [

<!--
SECTION 1:
Variables that are modified by the workflow generation script.
-->

<!--
The following are variables that are not passed to the shell scripts 
that execute the various worklflow tasks but are used in other ways by
the workflow XML.
-->
<!ENTITY ACCOUNT       "">
<!ENTITY SCHED         ""> 
<!ENTITY QUEUE_DEFAULT "">
<!ENTITY QUEUE_HPSS    "">
<!ENTITY QUEUE_FCST    "">

<!ENTITY USHDIR  "">
<!ENTITY JOBSDIR "">
<!ENTITY EXPTDIR "">

<!ENTITY EXTRN_MDL_NAME_ICS  "">
<!ENTITY EXTRN_MDL_NAME_LBCS "">

<!ENTITY EXTRN_MDL_FILES_SYSBASEDIR_ICS  "">
<!ENTITY EXTRN_MDL_FILES_SYSBASEDIR_LBCS "">

<!ENTITY DATE_FIRST_CYCL "">
<!ENTITY DATE_LAST_CYCL  "">
<!ENTITY YYYY_FIRST_CYCL "">
<!ENTITY MM_FIRST_CYCL   "">
<!ENTITY DD_FIRST_CYCL   "">
<!ENTITY HH_FIRST_CYCL   "">

<!ENTITY FHR "">

<!ENTITY RUN_TASK_MAKE_GRID      "">
<!ENTITY RUN_TASK_MAKE_OROG      "">
<!ENTITY RUN_TASK_MAKE_SFC_CLIMO "">

<!--
The following are variables that are passed to the shell scripts that 
execute the various workflow tasks but are not otherwise used in the 
workflow XML.
-->
<!ENTITY SCRIPT_VAR_DEFNS_FP "">
<!ENTITY CYCLE_DIR           "">

<!--
SECTION 2:
Variables that are not modified by the workflow generation script.
-->
<!ENTITY LOG_DIR "&EXPTDIR;/log">

<!ENTITY PROC_MAKE_GRID           "1:ppn=24">
<!ENTITY PROC_MAKE_OROG           "1:ppn=24">
<!ENTITY PROC_MAKE_SFC_CLIMO      "2:ppn=24">
<!ENTITY PROC_GET_EXTRN_MDL_FILES "1:ppn=1">
<!ENTITY PROC_MAKE_ICS_SURF_LBC0  "4:ppn=12">
<!ENTITY PROC_MAKE_LBC1_TO_LBCN   "4:ppn=12">
<!ENTITY PROC_RUN_FV3             "">
<!ENTITY PROC_POST                "2:ppn=24">

<!ENTITY RSRC_MAKE_GRID           "<walltime>00:10:00</walltime>">
<!ENTITY RSRC_MAKE_OROG           "<walltime>00:10:00</walltime>">
<!ENTITY RSRC_MAKE_SFC_CLIMO      "<walltime>00:25:00</walltime>">
<!ENTITY RSRC_GET_EXTRN_MDL_FILES "<walltime>00:45:00</walltime>">
<!ENTITY RSRC_MAKE_ICS_SURF_LBC0  "<walltime>00:30:00</walltime>">
<!ENTITY RSRC_MAKE_LBC1_TO_LBCN   "<walltime>00:30:00</walltime>">
<!ENTITY RSRC_RUN_FV3             "<walltime>07:30:00</walltime>">
<!ENTITY RSRC_POST                "<walltime>00:30:00</walltime>">

<!ENTITY RSRV_DEFAULT "<queue>&QUEUE_DEFAULT;</queue><account>&ACCOUNT;</account>"> 
<!ENTITY RSRV_HPSS    "<partition>&QUEUE_HPSS;</partition><account>&ACCOUNT;</account>"> 
<!ENTITY RSRV_RUN_FV3 "<queue>&QUEUE_FCST;</queue><account>&ACCOUNT;</account>"> 

]>

<workflow realtime="F" scheduler="&SCHED;" cyclethrottle="20">

  <cycledef group="at_start">00 &HH_FIRST_CYCL; &DD_FIRST_CYCL; &MM_FIRST_CYCL; &YYYY_FIRST_CYCL; *</cycledef>
  <cycledef group="at_CCZ">&DATE_FIRST_CYCL;CC00 &DATE_LAST_CYCL;CC00 24:00:00</cycledef>  <!-- This line will be replaced with one or more lines with "CC" replaced by actual cycle hours, e.g. "00". -->

  <log>
    <cyclestr>&LOG_DIR;/FV3_wflow.log</cyclestr>
  </log>
<!--
************************************************************************
************************************************************************
-->
  <task name="make_grid" cycledefs="at_start" maxtries="4">

    &RSRC_MAKE_GRID;
    &RSRV_DEFAULT;

    <command>&JOBSDIR;/JREGIONAL_MAKE_GRID</command>
    <nodes>&PROC_MAKE_GRID;</nodes>
    <jobname>make_grid</jobname>
    <join><cyclestr>&LOG_DIR;/make_grid.log</cyclestr></join>

    <envar><name>SCRIPT_VAR_DEFNS_FP</name><value>&SCRIPT_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>

    <dependency>
      <streq><left>&RUN_TASK_MAKE_GRID;</left><right>TRUE</right></streq>
    </dependency>

  </task>
<!--
************************************************************************
************************************************************************
-->
  <task name="make_orog" cycledefs="at_start" maxtries="4">

    &RSRC_MAKE_OROG;
    &RSRV_DEFAULT;

    <command>&JOBSDIR;/JREGIONAL_MAKE_OROG</command>
    <nodes>&PROC_MAKE_OROG;</nodes>
    <jobname>make_orog</jobname>
    <join><cyclestr>&LOG_DIR;/make_orog.log</cyclestr></join>

    <envar><name>SCRIPT_VAR_DEFNS_FP</name><value>&SCRIPT_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>

    <dependency>
      <and>
        <streq><left>&RUN_TASK_MAKE_OROG;</left><right>TRUE</right></streq>
        <or>
          <taskdep task="make_grid"/>
          <streq><left>&RUN_TASK_MAKE_GRID;</left><right>FALSE</right></streq>
        </or>
      </and>
    </dependency>

  </task>
<!--
************************************************************************
************************************************************************
-->
  <task name="make_sfc_climo" cycledefs="at_start" maxtries="2">

    &RSRC_MAKE_SFC_CLIMO;
    &RSRV_DEFAULT;

    <command>&JOBSDIR;/JREGIONAL_MAKE_SFC_CLIMO</command>
    <nodes>&PROC_MAKE_SFC_CLIMO;</nodes>
    <jobname>make_sfc_climo</jobname>
    <join><cyclestr>&LOG_DIR;/make_sfc_climo.log</cyclestr></join>

    <envar><name>SCRIPT_VAR_DEFNS_FP</name><value>&SCRIPT_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>

    <dependency>
      <and>
        <streq><left>&RUN_TASK_MAKE_SFC_CLIMO;</left><right>TRUE</right></streq>
        <or>
          <taskdep task="make_grid"/>
          <streq><left>&RUN_TASK_MAKE_GRID;</left><right>FALSE</right></streq>
        </or>
        <or>
          <taskdep task="make_orog"/>
          <streq><left>&RUN_TASK_MAKE_OROG;</left><right>FALSE</right></streq>
        </or>
      </and>
    </dependency>

  </task>
<!--
************************************************************************
************************************************************************
-->
  <task name="get_files_ICS" maxtries="3">

    &RSRC_GET_EXTRN_MDL_FILES;
    &RSRV_HPSS;

    <command>&JOBSDIR;/JREGIONAL_GET_EXTRN_FILES</command>
    <nodes>&PROC_GET_EXTRN_MDL_FILES;</nodes>
    <jobname>get_files_ICS</jobname>
    <join><cyclestr>&LOG_DIR;/get_files_ICS_@Y@m@d@H.log</cyclestr></join>

    <envar><name>SCRIPT_VAR_DEFNS_FP</name><value>&SCRIPT_VAR_DEFNS_FP;</value></envar>
    <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_DIR;</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>EXTRN_MDL_NAME</name><value>&EXTRN_MDL_NAME_ICS;</value></envar>
    <envar><name>ICS_OR_LBCS</name><value>ICS</value></envar>

  </task> 
<!--
************************************************************************
************************************************************************
-->
  <task name="get_files_LBCS" maxtries="3">

    &RSRC_GET_EXTRN_MDL_FILES;
    &RSRV_HPSS;

    <command>&JOBSDIR;/JREGIONAL_GET_EXTRN_FILES</command>
    <nodes>&PROC_GET_EXTRN_MDL_FILES;</nodes>
    <jobname>get_files_LBCS</jobname>
    <join><cyclestr>&LOG_DIR;/get_files_LBCS_@Y@m@d@H.log</cyclestr></join>

    <envar><name>SCRIPT_VAR_DEFNS_FP</name><value>&SCRIPT_VAR_DEFNS_FP;</value></envar>
    <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_DIR;</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>EXTRN_MDL_NAME</name><value>&EXTRN_MDL_NAME_LBCS;</value></envar>
    <envar><name>ICS_OR_LBCS</name><value>LBCS</value></envar>

  </task> 
<!--
************************************************************************
************************************************************************
-->
  <task name="make_ICS_surf_LBC0" maxtries="3">

    &RSRC_MAKE_ICS_SURF_LBC0;
    &RSRV_DEFAULT;

    <command>&JOBSDIR;/JREGIONAL_MAKE_IC_LBC0</command>
    <nodes>&PROC_MAKE_ICS_SURF_LBC0;</nodes>
    <jobname>make_ICS_surf_LBC0</jobname>
    <join><cyclestr>&LOG_DIR;/make_ICS_surf_LBC0_@Y@m@d@H.log</cyclestr></join>

    <envar><name>SCRIPT_VAR_DEFNS_FP</name><value>&SCRIPT_VAR_DEFNS_FP;</value></envar>
    <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_DIR;</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>

    <dependency>
      <and>
        <taskdep task="get_files_ICS"/>
        <or>
          <taskdep task="make_grid"/>
          <streq><left>&RUN_TASK_MAKE_GRID;</left><right>FALSE</right></streq>
        </or>
        <or>
          <taskdep task="make_orog"/>
          <streq><left>&RUN_TASK_MAKE_OROG;</left><right>FALSE</right></streq>
        </or>
        <or>
          <taskdep task="make_sfc_climo"/>
          <streq><left>&RUN_TASK_MAKE_SFC_CLIMO;</left><right>FALSE</right></streq>
        </or>
      </and>
    </dependency>

  </task>
<!--
************************************************************************
************************************************************************
-->
  <task name="make_LBC1_to_LBCN" maxtries="3">

    &RSRC_MAKE_LBC1_TO_LBCN;
    &RSRV_DEFAULT;

    <command>&JOBSDIR;/JREGIONAL_MAKE_LBC1_TO_LBCN</command>
    <nodes>&PROC_MAKE_LBC1_TO_LBCN;</nodes>
    <jobname>make_LBC1_to_LBCN</jobname>
    <join><cyclestr>&LOG_DIR;/make_LBC1_to_LBCN_@Y@m@d@H.log</cyclestr></join>

    <envar><name>SCRIPT_VAR_DEFNS_FP</name><value>&SCRIPT_VAR_DEFNS_FP;</value></envar>
    <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_DIR;</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>

    <dependency>
      <and>
        <taskdep task="get_files_LBCS"/>
        <or>
          <taskdep task="make_grid"/>
          <streq><left>&RUN_TASK_MAKE_GRID;</left><right>FALSE</right></streq>
        </or>
        <or>
          <taskdep task="make_orog"/>
          <streq><left>&RUN_TASK_MAKE_OROG;</left><right>FALSE</right></streq>
        </or>
        <or>
          <taskdep task="make_sfc_climo"/>
          <streq><left>&RUN_TASK_MAKE_SFC_CLIMO;</left><right>FALSE</right></streq>
        </or>
      </and>
    </dependency>

  </task>
<!--
************************************************************************
************************************************************************
-->
  <task name="run_FV3" maxtries="3">

    &RSRC_RUN_FV3;
    &RSRV_RUN_FV3;

    <command>&JOBSDIR;/JREGIONAL_RUN_FV3</command>
    <nodes>&PROC_RUN_FV3;</nodes>
    <jobname>run_FV3</jobname>
    <join><cyclestr>&LOG_DIR;/run_FV3_@Y@m@d@H.log</cyclestr></join>

    <envar><name>SCRIPT_VAR_DEFNS_FP</name><value>&SCRIPT_VAR_DEFNS_FP;</value></envar>
    <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_DIR;</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>

    <dependency>
      <and>
        <taskdep task="make_ICS_surf_LBC0"/>
        <taskdep task="make_LBC1_to_LBCN"/>
      </and>
    </dependency>

  </task>
<!--
************************************************************************
************************************************************************
-->
  <metatask name="post">
    
    <var name="fhr">&FHR;</var>
    
    <task name="post_#fhr#" maxtries="2">
    
      &RSRC_POST;
      &RSRV_DEFAULT;

      <command>&JOBSDIR;/JREGIONAL_RUN_POST</command>
      <nodes>&PROC_POST;</nodes>
      <jobname>run_post_#fhr#</jobname>
      <join><cyclestr>&LOG_DIR;/run_post_#fhr#_@Y@m@d@H.log</cyclestr></join>

      <envar><name>SCRIPT_VAR_DEFNS_FP</name><value>&SCRIPT_VAR_DEFNS_FP;</value></envar>
      <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_DIR;</cyclestr></value></envar>
      <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
      <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
      <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
      <envar><name>fhr</name><value>#fhr#</value></envar>

      <dependency>
        <and>
          <datadep age="05:00"><cyclestr>&CYCLE_DIR;/dynf0#fhr#.nc</cyclestr></datadep>
          <datadep age="05:00"><cyclestr>&CYCLE_DIR;/phyf0#fhr#.nc</cyclestr></datadep>
        </and>
      </dependency>

    </task>

  </metatask>

</workflow>
