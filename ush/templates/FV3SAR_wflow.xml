<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE workflow [

<!--
The following are variables needed only by the shell scripts that exe-
cute the various workflow tasks, i.e. they are not needed by rocoto to
run this workflow.  Thus, they may be passed as environment variables to
the scripts, but they will not appear in any of the xml code below that 
rocoto reads.
-->
<?ignore

<!ENTITY MACHINE "">
<!ENTITY BASEDIR "">
<!ENTITY FV3SAR_DIR "">
<!ENTITY TEMPLATE_DIR "">
<!ENTITY TMPDIR "">

<!ENTITY FCST_LEN_HRS "">
<!ENTITY BC_UPDATE_INTVL_HRS "">

<!ENTITY GTYPE "">
<!ENTITY RES "">
<!ENTITY STRETCH_FAC "">
<!ENTITY LON_CTR_T6 "">
<!ENTITY LAT_CTR_T6 "">
<!ENTITY REFINE_RATIO "">
<!ENTITY ISTART_RGNL_T6 "">
<!ENTITY IEND_RGNL_T6 "">
<!ENTITY JSTART_RGNL_T6 "">
<!ENTITY JEND_RGNL_T6 "">
<!ENTITY RUN_TITLE "">

<!ENTITY PREDEF_RGNL_DOMAIN "">

<!ENTITY LAYOUT_X "">
<!ENTITY LAYOUT_Y "">
<!ENTITY QUILTING "">
<!ENTITY PRINT_ESMF "">
<!ENTITY WRITE_GROUPS "">
<!ENTITY WRITE_TASKS_PER_GROUP "">

<!ENTITY NCORES_PER_NODE "">

?>

<!-- <!ENTITY TMPDIR "&BASEDIR;/work_dirs"> -->

<!--
The following are variables needed both by rocoto and by the shell 
scripts that execute the various workflow tasks.
-->

<!--
The following are variables that are passed to the shell scripts that 
execute the various workflow tasks but are not otherwise used in the 
workflow XML.
-->
<!ENTITY SCRIPT_VAR_DEFNS_FP "">
<!--
The following are variables that are not passed to the shell scripts 
that execute the various worklflow tasks but are used in other ways by
the workflow XML.
-->
<!ENTITY ACCOUNT "">
<!ENTITY USHDIR "">
<!ENTITY RUNDIR "">
<!-- <!ENTITY PROC_RUN_FV3SAR "11:ppn=24"> -->
<!ENTITY PROC_RUN_FV3SAR "">




<!ENTITY QUEUE_DEFAULT "debug">
<!ENTITY QUEUE_HPSS "service">
<!ENTITY QUEUE_RUN_FV3SAR "batch">
<!ENTITY SCHED "moabtorque"> 
<!ENTITY LOG_DIR "&RUNDIR;/log">

<!ENTITY UPPDIR "/scratch4/BMC/hmtb/beck/rapid-refresh/UPP/comupp/bin">
<!ENTITY FIX "/scratch3/BMC/det/beck/FV3-CAM/">
<!ENTITY FHR "00 01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24">

<!-- <!ENTITY PROC_CREATE_VAR_DEFNS "1:ppn=1"> -->
<!ENTITY PROC_GET_GFS_FILES      "1:ppn=1">
<!ENTITY PROC_MAKE_GRID_OROG    "1:ppn=24">
<!ENTITY PROC_MAKE_SURF_IC_BC0  "1:ppn=24">
<!ENTITY PROC_MAKE_BC1_TO_BCEND "1:ppn=24">
<!ENTITY PROC_STAGE             "1:ppn=1">
<!ENTITY PROC_POST              "1:ppn=24">

<!-- <!ENTITY RSRC_CREATE_VAR_DEFNS "<walltime>00:05:00</walltime>"> -->
<!ENTITY RSRC_GET_GFS_FILES      "<walltime>00:20:00</walltime>">
<!ENTITY RSRC_MAKE_GRID_OROG    "<walltime>00:15:00</walltime>">
<!ENTITY RSRC_MAKE_SURF_IC_BC0  "<walltime>00:10:00</walltime>">
<!ENTITY RSRC_MAKE_BC1_TO_BCEND "<walltime>00:20:00</walltime>">
<!ENTITY RSRC_STAGE             "<walltime>00:10:00</walltime>">
<!ENTITY RSRC_RUN_FV3SAR        "<walltime>03:00:00</walltime>">
<!ENTITY RSRC_POST              "<walltime>00:30:00</walltime>">

<!ENTITY RSRV_DEFAULT    '<native>-W umask=022 -m n</native><queue>&QUEUE_DEFAULT;</queue><account>&ACCOUNT;</account>'> 
<!ENTITY RSRV_HPSS       '<native>-W umask=022 -m n</native><queue>&QUEUE_HPSS;</queue><account>&ACCOUNT;</account>'> 
<!ENTITY RSRV_RUN_FV3SAR '<native>-W umask=022 -m n</native><queue>&QUEUE_RUN_FV3SAR;</queue><account>&ACCOUNT;</account>'> 

]>

<workflow realtime="F" scheduler="&SCHED;" cyclethrottle="20">

<cycledef>00 00 04 06 2018 *</cycledef>

  <log>
    <cyclestr>&LOG_DIR;/FV3_@Y@m@d@H.log</cyclestr>
  </log>

<?ignore
  <task name="create_var_defns_script" maxtries="4">

    &RSRC_CREATE_VAR_DEFNS;
    &RSRV_DEFAULT;

    <command>&USHDIR;/create_var_defns_script.sh</command>
    <nodes>&PROC_CREATE_VAR_DEFNS;</nodes>
    <jobname>create_var_defns</jobname>
    <join><cyclestr>&LOG_DIR;/create_var_defns_script_@Y@m@d@H.log</cyclestr></join>

    <envar>
      <name>machine</name>
      <value>&MACHINE;</value>
    </envar>

    <envar>
      <name>BASEDIR</name>
      <value>&BASEDIR;</value>
    </envar>

    <envar>
      <name>FV3SAR_DIR</name>
      <value>&FV3SAR_DIR;</value>
    </envar>

    <envar>
      <name>TEMPLATE_DIR</name>
      <value>&TEMPLATE_DIR;</value>
    </envar>

    <envar>
      <name>TMPDIR</name>
      <value>&TMPDIR;</value>
    </envar>

    <envar>
      <name>gtype</name>
      <value>&GTYPE;</value>
    </envar>

    <envar>
      <name>RES</name>
      <value>&RES;</value>
    </envar>

    <envar>
      <name>stretch_fac</name>
      <value>&STRETCH_FAC;</value>
    </envar>

    <envar>
      <name>lon_tile6_ctr</name>
      <value>&LON_CTR_T6;</value>
    </envar>

    <envar>
      <name>lat_tile6_ctr</name>
      <value>&LAT_CTR_T6;</value>
    </envar>

    <envar>
      <name>refine_ratio</name>
      <value>&REFINE_RATIO;</value>
    </envar>

    <envar>
      <name>istart_nest_tile6</name>
      <value>&ISTART_RGNL_T6;</value>
    </envar>

    <envar>
      <name>iend_nest_tile6</name>
      <value>&IEND_RGNL_T6;</value>
    </envar>

    <envar>
      <name>jstart_nest_tile6</name>
      <value>&JSTART_RGNL_T6;</value>
    </envar>

    <envar>
      <name>jend_nest_tile6</name>
      <value>&JEND_RGNL_T6;</value>
    </envar>

    <envar>
      <name>title</name>
      <value>&RUN_TITLE;</value>
    </envar>

    <envar>
      <name>predef_rgnl_domain</name>
      <value>&PREDEF_RGNL_DOMAIN;</value>
    </envar>

  </task>
?>

  <task name="make_grid_orog" maxtries="4">

    &RSRC_MAKE_GRID_OROG;
    &RSRV_DEFAULT;

    <command>&USHDIR;/make_grid_orog.sh</command>
    <nodes>&PROC_MAKE_GRID_OROG;</nodes>
    <jobname>make_grid_orog</jobname>
    <join><cyclestr>&LOG_DIR;/make_grid_orog_@Y@m@d@H.log</cyclestr></join>

    <envar>
      <name>SCRIPT_VAR_DEFNS_FP</name>
      <value>&SCRIPT_VAR_DEFNS_FP;</value>
    </envar>

  </task>


  <task name="get_GFS_files" maxtries="3">

    &RSRC_GET_GFS_FILES;
    &RSRV_HPSS;

    <command>&USHDIR;/get_GFS_files.sh</command>
    <nodes>&PROC_GET_GFS_FILES;</nodes>
    <jobname>get_GFS_anl_fcst_files</jobname>
    <join><cyclestr>&LOG_DIR;/get_GFS_anl_fcst_files_@Y@m@d@H.log</cyclestr></join>

    <envar>
      <name>SCRIPT_VAR_DEFNS_FP</name>
      <value>&SCRIPT_VAR_DEFNS_FP;</value>
    </envar>

    <envar>
      <name>CDATE</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>

    <dependency>
       <taskdep task="make_grid_orog"/>
    </dependency>

  </task> 


  <task name="make_surf_IC_BC0" maxtries="3">

    &RSRC_MAKE_SURF_IC_BC0;
    &RSRV_DEFAULT;

    <command>&USHDIR;/make_surf_IC_BC0.sh</command>
    <nodes>&PROC_MAKE_SURF_IC_BC0;</nodes>
    <jobname>/make_surf_IC_BC0</jobname>
    <join><cyclestr>&LOG_DIR;/make_surf_IC_BC0_@Y@m@d@H.log</cyclestr></join>
    
    <envar>
      <name>SCRIPT_VAR_DEFNS_FP</name>
      <value>&SCRIPT_VAR_DEFNS_FP;</value>
    </envar>

    <envar>
      <name>CDATE</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>

    <dependency>
     <and>
      <taskdep task="make_grid_orog"/>
      <taskdep task="get_GFS_anl_fcst_files"/>
     </and> 
   </dependency>

  </task>


  <task name="make_BC1_to_BCend" maxtries="3">

    &RSRC_MAKE_BC1_TO_BCEND;
    &RSRV_DEFAULT;

    <command>&USHDIR;/make_BC1_to_BCend.sh</command>
    <nodes>&PROC_MAKE_BC1_TO_BCEND;</nodes>
    <jobname>/make_BC1_to_BCend</jobname>
    <join><cyclestr>&LOG_DIR;/make_BC1_to_BCend_@Y@m@d@H.log</cyclestr></join>

    <envar>
      <name>SCRIPT_VAR_DEFNS_FP</name>
      <value>&SCRIPT_VAR_DEFNS_FP;</value>
    </envar>

    <envar>
      <name>CDATE</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>

    <dependency>
     <and>
      <taskdep task="make_grid_orog"/>
      <taskdep task="get_GFS_anl_fcst_files"/>
     </and>
    </dependency>

  </task>


  <task name="stage" maxtries="2">

    &RSRC_STAGE;
    &RSRV_DEFAULT;

    <command>&USHDIR;/stage.sh</command>
    <nodes>&PROC_STAGE;</nodes>
    <jobname>stage</jobname>
    <join><cyclestr>&LOG_DIR;/stage_@Y@m@d@H.log</cyclestr></join>

    <envar>
      <name>SCRIPT_VAR_DEFNS_FP</name>
      <value>&SCRIPT_VAR_DEFNS_FP;</value>
    </envar>

    <envar>
      <name>CDATE</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>

    <dependency>
     <and>
      <taskdep task="make_surf_IC_BC0"/>
      <taskdep task="make_BC1_to_BCend"/>
     </and>
    </dependency>

  </task>


  <task name="run_FV3SAR" maxtries="3">

    &RSRC_RUN_FV3SAR;
    &RSRV_RUN_FV3SAR;

    <command>&USHDIR;/run_FV3SAR.sh</command>
    <nodes>&PROC_RUN_FV3SAR;</nodes>
    <jobname>run_FV3SAR</jobname>
    <join><cyclestr>&LOG_DIR;/run_FV3SAR_@Y@m@d@H.log</cyclestr></join>

    <envar>
      <name>SCRIPT_VAR_DEFNS_FP</name>
      <value>&SCRIPT_VAR_DEFNS_FP;</value>
    </envar>

    <dependency>
      <taskdep task="stage"/>
    </dependency>

  </task>


<?ignore
  <metatask name="post">
    
    <var name="fhr">&FHR;<var>
    
    <task name="post#fhr#" maxtries="2">
    
    &RSRC_POST;
    &RSRV_DEFAULT;

    <command>&USHDIR;/run_post.sh</command>
    <nodes>&PROC_POST;</nodes>
    <jobname>run_post</jobname>
    <join><cyclestr>&LOG_DIR;/run_post_@Y@m@d@H.log</cyclestr></join>

    <envar>
      <name>CDATE</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
   
    <envar>
      <name>UPPDIR</name>
      <value>&UPPDIR;</value>
    </envar>
 
    <envar>
      <name>fhr</name>
      <value>#fhr#</value>
    </envar>

    <envar>
      <name>FIX</name>
      <value>&FIX;</value>
    </envar>

    <dependency>
      <and>
        <datadep age="05:00"><cyclestr>&RUNDIR;/dynf0#fhr#.nc</cyclestr></datadep>
        <datadep age="05:00"><cyclestr>&RUNDIR;/phyf0#fhr#.nc</cyclestr></datadep>
      </and>
    </dependency>

    </task>

  </metatask>
?>

</workflow>
