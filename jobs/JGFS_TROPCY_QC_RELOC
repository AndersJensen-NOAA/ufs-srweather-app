#!/bin/sh

set -xa
export PS4='$SECONDS + '
date

# #### 01/12/2016 #############################################
# SETUP GFS TROPICAL CYCLONE QC/RELOCATION PROCESSING VARIABLES
# #############################################################

####################################
# obtain unique process id (pid) and make temp directory
####################################
export pid=$$
export DATA=${DATA:-$DATAROOT/${job}.${pid}}
if [ ! -d ${DATA} ]; then
  mkdir -p $DATA
fi
cd $DATA

export cycle=t${cyc}z
export tmmark=tm00
export RUN_ENVIR=${RUN_ENVIR:-nco}
export envir=${envir:-prod}
# JY export envir_getges=${envir_getges:-prod}
export envir_getges=${envir_getges:-${envir}}
export COMROOT=${COMROOT:-/com2}
export NWROOT=${NWROOT:-/nwprod2}
export COMROOTp1=${COMROOTp1:-/com}
export NWROOTp1=${NWROOTp1:-/nwprod}
export DCOMROOT=${DCOMROOT:-/dcom}
export DBNROOT=${DBNROOT:-$NWROOTp1/spa_util/fakedbn}
export global_shared_ver=${global_shared_ver:-${gfs_ver}}

##########################
# Specify NET and RUN Name
##########################
export NET=gfs
export RUN=gfs

#######################################
# Specify non prod environment variable
######################################

####################################
# Determine Job Output Name on System
####################################
export outid="LL$job"
# JY if [ $envir != prod ]; then
#   export outid="LL${job}_${envir}"
#fi
# JY export jobid="${outid}.o${pid}"
export pgmout="OUTPUT.${pid}"

####################################
# SENDECF  - Flag Events on ecFlow
# SENDCOM  - Copy Files From TMPDIR to $COMOUT
# SENDDBN  - Issue DBNet Client Calls
# SENDSDM  - Send email to SDM if No JTWC bulletins
# copy_back - copy updated tc files back to archive and NHC dir (default=YES in syndat_qctropcy.sh)
####################################
export SENDECF=${SENDECF:-YES}
export SENDCOM=${SENDCOM:-YES}
export SENDDBN=${SENDDBN:-YES}
export SENDSDM=${SENDSDM:-YES}
if [ $envir != prod ]; then
  # JY export copy_back=${copy_back:-NO}
  export maillist='ncep.list.spa-helpdesk@noaa.gov'
fi

export maillist=${maillist:-'sdm@noaa.gov'}

####################################
# File To Log Msgs
####################################
export jlogfile=${jlogfile:-$COMROOT/logs/jlogfiles/jlogfile.${job}.${pid}}

####################################
# Specify Execution Areas
####################################

# JY export HOMEarch=${HOMEarch:-$COMROOTp1/arch/prod}
export HOMEarch=${HOMEarch:-$COMROOTp1/arch/${envir}}
export ARCHSYND=${HOMEarch}/syndat

if [ ! -d ${ARCHSYND} ]; then
  mkdir -p $ARCHSYND
fi

export HOMENHC=${HOMENHC:-/gpfs/?p1/nhc/save/guidance/storm-data/ncep}

export HOMEglobal=${HOMEglobal:-${NWROOT}/global_shared.${global_shared_ver}}
export HOMESYND=${HOMESYND:-$HOMEglobal}
#export HOMESYND=${HOMESYND:-${NWROOT}/tropcy_qc_reloc.${tropcy_qc_reloc_ver}}
export EXECSYND=${EXECSYND:-${HOMESYND}/exec}
export FIXSYND=${FIXSYND:-${HOMESYND}/fix}
export PARMSYND=${PARMSYND:-${HOMESYND}/parm}
export USHSYND=${USHSYND:-${HOMESYND}/ush}

export TANK_TROPCY=${TANK_TROPCY:-${DCOMROOT}/us007003}   # path to tropical cyclone record database
                                                          #  (used by qctropcy processing)

export HOMERELO=${HOMERELO:-$HOMEglobal}
#export HOMERELO=${HOMERELO:-${NWROOT}/tropcy_qc_reloc.${tropcy_qc_reloc_ver}}
export EXECRELO=${EXECRELO:-${HOMERELO}/exec}
export FIXRELO=${FIXRELO:-${HOMERELO}/fix}
export USHRELO=${USHRELO:-${HOMERELO}/ush}

###################################
# Set up the UTILITIES
###################################
export machine=${machine:-WCOSS_C}
if [ $machine = WCOSS_C ] ; then
   export APRNGETTX="time aprun -q -j1 -n1 -N1 -d1 -cc depth"
   export APRNRELOC="time aprun -q -j1 -n7 -N1 -d24 -cc depth "
   export APRNSYNDX="time aprun -q -j1 -n1 -N1 -d1 -cc depth"
fi

##############################
# Run setpdy and initialize PDY variables
##############################
#which setpdy.sh
#echo $NDATE
setpdy.sh
. PDY

##############################################
# Define COM directories
##############################################
export COMINgfs=${COMINgfs:-${COMROOT}/gfs/${envir}/gfs.${PDY}}
export COMINgdas=${COMINgdas:-${COMROOT}/gfs/${envir}/gdas.${PDY}}
export COMIN=${COMIN:-${COMROOT}/${NET}/${envir}/${RUN}.${PDY}}
export COMOUT=${COMOUT:-${COMROOT}/${NET}/${envir}/${RUN}.${PDY}}
if [ ! -d ${COMOUT} ]; then
  mkdir -p $COMOUT
fi

##############################################
# Specify varaibles specific to this execution of script
##############################################

# VARIABLES THAT CONTROL PROCESSING OF INDIVIDUAL PROGRAMS
# --------------------------------------------------------

#  Normally both PROCESS_TROPCY and DO_RELOCATE should be set to YES

export PROCESS_TROPCY=${PROCESS_TROPCY:-YES}    # Turn on tropical cyclone tcvitals QC proc. if YES
export DO_RELOCATE=${DO_RELOCATE:-NO}           # Turn on tropical cyclone relocation proc. if YES

export LONB=3072 # sigma guess parm needed by tropical cyclone reloc. processing
export LATB=1536  # sigma guess parm needed by tropical cyclone reloc. processing

export BKGFREQ=1 # for hourly relocation

env

#############################################################
# execute the script
sh ${HOMERELO}/scripts/extropcy_qc_reloc.sh.ecf
#############################################################

cd $DATAROOT
if [ "${CLEAN:-YES}" = YES ]; then
  rm -rf $DATA
fi

date
